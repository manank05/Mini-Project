package com.example.ons;

import com.example.ons.config.AppConfig;
import com.example.ons.model.Course;
import com.example.ons.model.Student;
import com.example.ons.service.FeeService;
import com.example.ons.service.StudentService;
import org.springframework.context.annotation.AnnotationConfigApplicationContext;

import java.math.BigDecimal;
import java.util.List;
import java.util.Scanner;

public class MainApp {

    public static void main(String[] args) {
        AnnotationConfigApplicationContext ctx =
                new AnnotationConfigApplicationContext(AppConfig.class);

        StudentService studentService = ctx.getBean(StudentService.class);
        FeeService feeService = ctx.getBean(FeeService.class);

        Scanner sc = new Scanner(System.in);
        boolean running = true;

        while (running) {
            System.out.println("\n--- Online Student Management ---");
            System.out.println("1. Add student");
            System.out.println("2. List students");
            System.out.println("3. Update student name");
            System.out.println("4. Delete student");
            System.out.println("5. Make payment");
            System.out.println("6. Refund");
            System.out.println("7. Exit");
            System.out.print("Choose: ");
            int choice = Integer.parseInt(sc.nextLine());

            try {
                switch (choice) {
                    case 1:
                        System.out.print("Name: ");
                        String name = sc.nextLine();
                        System.out.print("Course name: ");
                        String cname = sc.nextLine();
                        Course c = new Course(cname, "3 months");
                        // Persist course using session or create a CourseDAO; for demo, attach transient course
                        Student s = new Student(name, c, BigDecimal.valueOf(1000.00));
                        Integer id = studentService.addStudent(s);
                        System.out.println("Added student with ID: " + id);
                        break;
                    case 2:
                        List<Student> list = studentService.listAll();
                        for (Student st : list) {
                            System.out.println(st.getStudentId() + " | " + st.getName() + " | " +
                                    (st.getCourse() != null ? st.getCourse().getCourseName() : "No course") +
                                    " | Balance: " + st.getBalance());
                        }
                        break;
                    case 3:
                        System.out.print("Student ID: ");
                        int sid = Integer.parseInt(sc.nextLine());
                        Student st = studentService.getStudent(sid);
                        if (st == null) System.out.println("Not found");
                        else {
                            System.out.print("New name: ");
                            st.setName(sc.nextLine());
                            studentService.updateStudent(st);
                            System.out.println("Updated.");
                        }
                        break;
                    case 4:
                        System.out.print("Student ID to delete: ");
                        int delId = Integer.parseInt(sc.nextLine());
                        studentService.deleteStudent(delId);
                        System.out.println("Deleted if existed.");
                        break;
                    case 5:
                        System.out.print("Student ID: ");
                        int pid = Integer.parseInt(sc.nextLine());
                        System.out.print("Amount: ");
                        BigDecimal amt = new BigDecimal(sc.nextLine());
                        feeService.makePayment(pid, amt);
                        System.out.println("Payment done.");
                        break;
                    case 6:
                        System.out.print("Student ID: ");
                        int rid = Integer.parseInt(sc.nextLine());
                        System.out.print("Amount: ");
                        BigDecimal ramt = new BigDecimal(sc.nextLine());
                        feeService.refund(rid, ramt);
                        System.out.println("Refund processed.");
                        break;
                    case 7:
                        running = false;
                        break;
                    default:
                        System.out.println("Invalid");
                }
            } catch (Exception ex) {
                System.err.println("Operation failed: " + ex.getMessage());
            }
        }

        ctx.close();
        sc.close();
    }
}
